services:
  api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: second-api
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_started
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ConnectionStrings__DefaultConnection: Server=db,1433;Database=SecondDb;User Id=sa;Password=Your_password123;TrustServerCertificate=True;Encrypt=False
      Redis__ConnectionString: redis:6379
      Email__Enabled: ${EMAIL_ENABLED:-false}
      Email__FromAddress: ${EMAIL_FROM_ADDRESS:-noreply@example.com}
      Email__FromName: ${EMAIL_FROM_NAME:-Second}
      Email__SmtpHost: ${EMAIL_SMTP_HOST:-smtp.gmail.com}
      Email__SmtpPort: ${EMAIL_SMTP_PORT:-587}
      Email__UseSsl: ${EMAIL_USE_SSL:-true}
      Email__UseDefaultCredentials: ${EMAIL_USE_DEFAULT_CREDENTIALS:-false}
      Email__Username: ${EMAIL_USERNAME:-}
      Email__Password: ${EMAIL_PASSWORD:-}
      Email__TimeoutMilliseconds: ${EMAIL_TIMEOUT_MILLISECONDS:-10000}
      Jwt__Key: super-secret-development-key-change-in-production-123456
      Jwt__Issuer: Second.API
      Jwt__Audience: Second.Client
      Frontend__BaseUrl: http://localhost:3000
    ports:
      - "8080:8080"

  db:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: second-db
    environment:
      ACCEPT_EULA: "Y"
      MSSQL_SA_PASSWORD: Your_password123
    ports:
      - "1433:1433"
    volumes:
      - second-sql-data:/var/opt/mssql
    healthcheck:
      test: ["CMD-SHELL", "grep -q 'SQL Server is now ready for client connections' /var/opt/mssql/log/errorlog"]
      interval: 10s
      timeout: 5s
      retries: 30
      start_period: 30s

  redis:
    image: redis:7-alpine
    container_name: second-redis
    ports:
      - "6379:6379"
    volumes:
      - second-redis-data:/data

volumes:
  second-sql-data:
  second-redis-data:
